<style type="text/css">
.modal-dialog {
    width: 1200px;
    margin: 30px auto;
}
</style>
<div class="clearfix">
    <div class="panel panel-primary">
        <?php if ($this->utils->isEnabledFeature('enable_pep_gbg_api_authentication') && $this->permissions->checkPermissions('manual_generate_pep_authentication')) : ?>
                <label class="col-md-6">
                    <input type="checkbox" name="chkAutoUpdatePlayerStatus" id="chkAutoUpdatePlayerStatus" value="1" <?= (!$enable_auto_update_player_status_pep) ? "checked" : "" ?> onChange="autoUpdatePlayerStatus();">
                    <?= lang('Auto Update Player Status') ?>
                </label>
        <?php endif; ?>
        <div class="panel panel-body" id="player_panel_body">
            <table class="table table-bordered" style="margin-bottom:0;">
                <thead>
                    <tr>
                        <th class="active"><?=lang('lang.date')?></th>
                        <th class="active"><?=lang('Authentication ID')?></th>
                        <th class="active"><?=lang('Score')?></th>
                        <th class="active"><?=lang('Generated By')?></th>
                        <th class="active"><?=lang('Band Text')?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if(!empty($pep_auth_list)) : ?>
                        <?php foreach ($pep_auth_list as $key => $value) :?>
                            <tr>
                                <td><?=$value['timestamp']?></td>
                                <td><?=$value['auth_id']?></td>
                                <td><?=$value['score']?></td>
                                <td><?=$value['generated_by']?></td>
                                <td><?=$value['band_text']?><a class="pull-right" href="javascript:void(0)" onclick="showDetails('<?=$value['id']?>');"><i class="glyphicon glyphicon-question-sign"></i></a></td>
                            </tr>
                        <?php endforeach ; ?>
                    <?php else: ?>
                        <tr>
                            <td colspan="5"><center><?= lang('cashier.32') ?></center></td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>

        <div class="panel panel-body">
            <table class="table table-bordered" style="margin-bottom:0;" id="pep_info_body">
                <thead>
                    <tr></tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
    </div>


    <?php if($this->utils->isEnabledFeature('enable_pep_gbg_api_authentication') && $this->permissions->checkPermissions('manual_generate_pep_authentication')) : ?>
        <center id="btn_manual_pep_auth">
            <input type="submit" class="btn btn-primary submit_btn btn-sm" value="<?=lang('Generate New PEP Authentication');?>" onclick="manual_player_pep_status()">
        </center>
    <?php endif; ?>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        $('#pep_status').text('<?=$current_pep_status?>');
        $('#risk_score').text('<?=$total_score?>');
        $('#allowed_withdrawal_status').text('<?=$allowed_withdrawal_status?>');
    });

    function manual_player_pep_status() {
        if(confirm("<?= lang('Are you sure you want to generate PEP Authentication manually?'); ?>")) {
            $.post("/player_management/generate_manual_pep_authentication/<?=$playerId?>/true", function(result){
                if(result.status == "success"){
                    alert(result.msg);
                    modal('/player_management/player_pep_authentication/<?=$playerId?>','<?=lang('PEP Authentication')?>');
                } else {
                    alert(result.msg);
                }
            });
        }
    }

    function autoUpdatePlayerStatus(){
        var status = $("#chkAutoUpdatePlayerStatus").is(":checked");
        if(confirm("<?= lang('Are you sure you want to continue?'); ?>")) {
            $.post("/player_management/edit_update_auto_update_pep/<?=$playerId?>/"+status, function(result){
                if(result.status == "success"){
                    alert(result.msg);
                    modal('/player_management/player_pep_authentication/<?=$playerId?>','<?=lang('PEP Authentication')?>');
                } else {
                    alert(result.msg);
                }
            });
        }
    }

    function initializeDataTable(){
        $('#pep_info_body').DataTable({
            "bLengthChange": false,
            "bInfo": false,
            "bFilter": false,   
        });
    }

    function showDetails(pepLogsId) {
        $.post("/player_management/get_pep_auth_info/"+pepLogsId, function(result){
            $('#pep_info_body').empty();
            $('#pep_info_body').append($('<thead/>').append($('<tr/>')),$('<tbody/>'));
            $('#pep_info_body > thead > tr').append(
                    $('<th/>',{'class' : 'active', 'style' : 'text-align: center','html': '<a class="pull-left" href="javascript:void(0)" onclick="closePEPInfo()"><i class="pull-left text-danger"> X </i></a><?= lang("PEP Authentication Details")?>','colspan' : 2})
                );
            if(result.status == "success"){
                 $.each(result.data, function(i, val) {
                    if(i == "result_codes"){
                        $('#pep_info_body > tbody').append(
                            $('<tr/>').append(
                            $('<td/>',{'class' : '','html': i}),
                            $('<td/>',{'class' : 'result_codes','html':'<pre id="result_codes" name="result_codes" style="height: 600px">'+JSON.stringify(JSON.parse(val), null, 4)+'</pre>'})
                        ));
                        var result_codes = ace.edit("result_codes");
                        result_codes.setTheme("ace/theme/tomorrow");
                        result_codes.session.setMode("ace/mode/json");

                    } else {
                        $('#pep_info_body > tbody').append(
                             $('<tr/>').append(
                                 $('<td/>',{'class' : '','html': i}),
                                 $('<td/>',{'class' : '','html': val})
                             )
                        );
                    }
                });
                initializeDataTable();
            } else {
                 alert(result.msg);
            }
            
        });

    }

    function closePEPInfo() {
        $('#pep_info_body > thead > tr').empty();
        $('#pep_info_body > tbody').empty();
        $('#pep_info_body').hide();
    }
</script>
