<?php
require_once dirname(__FILE__) . '/abstract_telephone_api.php';

/**
 * SmartVoice telephone API implementation
 *
 * SMARTVOICE_TELEPHONE_API, ID: 101
 *
 * Required Fields:
 *
 * * URL
 * * Extra Info
 *
 * Field Values:
 *
 * * Live URL: http://47.90.34.136:8089/atstar/index.php/status-op
 * * Key: ## key ##
 * * Extra Info
 * > {
 * >    "smartvoice_op" : "dialv2",
 * >	"smartvoice_default_ext" : "## extension X ##"
 * > }
 *
 * For smartvoice_ext, fill in the ext numbers and a random one will be assigned to each URL.
 *
 * @category Telephone
 * @copyright 2013-2022 tot
 */
class Telephone_api_smartvoice extends Abstract_telephone_api {

	public function getPlatformCode() {
		return SMARTVOICE_TELEPHONE_API;
	}

	public function getCallUrl($phoneNumber, $callerId) {
		if(empty($callerId)) {
			$callerId = $this->getSystemInfo('smartvoice_default_ext');
		}

		$params = array(
			'op' => $this->getSystemInfo('smartvoice_op'),
			'ext_no' => $callerId,
			'dia_num' => $this->encryptNumber($phoneNumber)
		);

		$callUrl = $this->getSystemInfo('url') . '?' . http_build_query($params);
		$this->utils->debug_log("Call URL generated by SmartVoice: ", $callUrl);

		return array(
			'success' => true,
			'type' => self::REDIRECT_TYPE_GET_URL,
			'url' => $callUrl
		);
	}

	private function encryptNumber($phoneNumber) {
		$key = $this->getSystemInfo('key');
		$num = "1".$phoneNumber;
		return $num * 22 + $key;
	}
}
